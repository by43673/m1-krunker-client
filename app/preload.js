"use strict";
var q=Object.create;var T=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var G=(n,t)=>{for(var s in t)T(n,s,{get:t[s],enumerable:!0})},B=(n,t,s,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of W(t))!U.call(n,e)&&e!==s&&T(n,e,{get:()=>t[e],enumerable:!(a=F(t,e))||a.enumerable});return n};var A=(n,t,s)=>(s=n!=null?q(K(n)):{},B(t||!n||!n.__esModule?T(s,"default",{value:n,enumerable:!0}):s,n)),V=n=>B(T({},"__esModule",{value:!0}),n);var Y={};G(Y,{getTimezoneByRegionKey:()=>z,regionMappings:()=>O,strippedConsole:()=>w,styleSettingsCSS:()=>y});module.exports=V(Y);var g=require("fs"),m=require("path"),c=require("electron"),$=require("./matchmaker"),o=require("./utils"),R=require("./settingsui"),_=require("compare-versions"),x=A(require("dayjs")),D=A(require("dayjs/plugin/utc"));x.default.extend(D.default),window.OffCliV=!0;const w={error:console.error.bind(console),log:console.log.bind(console),warn:console.warn.bind(console),time:console.time.bind(console),timeEnd:console.timeEnd.bind(console)},C=(0,m.resolve)(__dirname,"..","assets"),y={hideAds:(0,g.readFileSync)((0,m.join)(C,"hideAds.css"),{encoding:"utf-8"}),menuTimer:(0,g.readFileSync)((0,m.join)(C,"menuTimer.css"),{encoding:"utf-8"}),quickClassPicker:(0,g.readFileSync)((0,m.join)(C,"quickClassPicker.css"),{encoding:"utf-8"})+(0,o.hiddenClassesImages)(16),hideReCaptcha:"body > div:not([class]):not([id]) > div:not(:empty):not([class]):not([id]) { display: none; }"};c.ipcRenderer.on("main_did-finish-load",(n,t)=>X(t)),c.ipcRenderer.on("checkForUpdates",async(n,t)=>{const e=(await(await fetch(`https://api.github.com/repos/${o.repoID}/releases/latest`)).json()).tag_name,l=(0,_.compareVersions)(t,e),i=(0,o.createElement)("div",{class:["crankshaft-holder-update","refresh-popup"],id:"#loadInfoUpdateHolder"});if(l===-1){i.appendChild((0,o.createElement)("a",{text:`New update! Download ${e}`}));const b=()=>{c.ipcRenderer.send("openExternal",`https://github.com/${o.repoID}/releases/latest`)};try{i.removeEventListener("click",b)}catch{}i.addEventListener("click",b)}else i.appendChild((0,o.createElement)("span",{text:"No new updates"}));w.log(`Crankshaft client v${t} latest: v${e}`),document.body.appendChild(i);let u=setTimeout(()=>i.remove(),5e3);i.onmouseenter=()=>clearTimeout(u),i.onmouseleave=()=>{u=setTimeout(()=>i.remove(),5e3)},document.addEventListener("pointerlockchange",()=>{clearTimeout(u),i.remove()},{once:!0})}),c.ipcRenderer.on("initDiscordRPC",()=>{function n(){w.log("> updated RPC");const t=document.getElementById("menuClassName"),s=document.querySelector("#menuClassSubtext > span"),a=document.getElementById("mapInfo"),e=(0,o.hasOwn)(window,"getGameActivity")?window.getGameActivity():{};let l=!1;(0,o.hasOwn)(e,"class")||(e.class={name:t?.textContent??""}),(!(0,o.hasOwn)(e,"map")||!(0,o.hasOwn)(e,"mode"))&&(l=a?.textContent??"Loading game...");const i={details:l||`${e.mode} on ${e.map}`,state:`${e.class.name} \u2022 ${s===null?"":s.textContent}`};s?c.ipcRenderer.send("preload_updates_DiscordRPC",i):c.ipcRenderer.send("preload_updates_DiscordRPC",{details:"Loading krunker...",state:"github.com/KraXen72/crankshaft"})}c.ipcRenderer.on("main_did-finish-load",n),window.addEventListener("load",()=>{n(),setTimeout(()=>{try{document.getElementById("windowCloser").addEventListener("click",n)}catch(t){w.error("didn't hook wincloser",t)}try{document.getElementById("customizeButton").addEventListener("click",n)}catch(t){w.error("didn't hook customizeButton",t)}},4e3)}),document.addEventListener("pointerlockchange",n)}),c.ipcRenderer.on("matchmakerRedirect",(n,t)=>(0,$.fetchGame)(t)),c.ipcRenderer.on("injectClientCSS",(n,t,s)=>{const{matchmaker:a,matchmaker_F6:e}=t;document.addEventListener("keydown",f=>{f.code==="Escape"&&document.exitPointerLock(),f.code==="F1"&&a&&!e&&c.ipcRenderer.send("matchmaker_requests_userPrefs")});const{hideAds:l,menuTimer:i,quickClassPicker:u,hideReCaptcha:b,clientSplash:S,userscripts:L}=t,d="Crankshaft-splash-css",r="Crankshaft-settings-css",p=(0,g.readFileSync)((0,m.join)(C,"settingCss.css"),{encoding:"utf-8"});if((0,o.injectSettingsCSS)(p,r),S){const f=(0,g.readFileSync)((0,m.join)(C,"splashCss.css"),{encoding:"utf-8"});(0,o.injectSettingsCSS)(f,d);const v=document.getElementById("instructionHider");if(v===null)throw"Krunker didn't create #instructionHider";const k=(0,o.createElement)("svg",{id:"crankshaft-logo-holder",innerHTML:(0,g.readFileSync)((0,m.join)(C,"full_logo.svg"),{encoding:"utf-8"})}),h=I=>{try{k.remove(),I.disconnect()}catch{console.log("splash screen was already cleared.")}};v.appendChild(k),k.appendChild((0,o.createElement)("div",{class:"crankshaft-holder-l",id:"#loadInfoLHolder",text:`v${s}`})),k.appendChild((0,o.createElement)("div",{class:"crankshaft-holder-r",id:"#loadInfoRHolder",text:"by KraXen72 and contributors"}));const E={attributes:!0,childList:!0,subtree:!0},N=(I,M)=>{for(const j of I)j.type==="childList"&&h(M)},H=new MutationObserver(N);H.observe(document.getElementById("instructions"),E),document.addEventListener("pointerlockchange",()=>{h(H)},{once:!0})}(l==="block"||l==="hide")&&((0,o.toggleSettingCSS)(y.hideAds,"hideAds",!0),document.getElementById("hiddenClasses").classList.add("hiddenClasses-hideAds-bottomOffset")),i&&(0,o.toggleSettingCSS)(y.menuTimer,"menuTimer",!0),u&&(0,o.toggleSettingCSS)(y.quickClassPicker,"quickClassPicker",!0),b&&(0,o.toggleSettingCSS)(y.hideReCaptcha,"hideReCaptcha",!0),L&&c.ipcRenderer.send("initializeUserscripts")});const O=[{name:"Frankfurt",id:"de-fra",code:"FRA",offset:2},{name:"Silicon Valley",id:"us-ca-sv",code:"SV",offset:-7},{name:"Sydney",id:"au-syd",code:"SYD",offset:10},{name:"Tokyo",id:"jb-hnd",code:"TOK",offset:9},{name:"Miami",id:"us-fl",code:"MIA",offset:-4},{name:"Singapore",id:"sgp",code:"SIN",offset:8},{name:"New York",id:"us-nj",code:"NY",offset:-4},{name:"Mumbai",id:"as-mb",code:"MBI",offset:5.5},{name:"Dallas",id:"us-tx",code:"DAL",offset:-5},{name:"Brazil",id:"brz",code:"BRZ",offset:-3},{name:"Middle East",id:"me-bhn",code:"BHN",offset:3},{name:"South Africa",id:"af-ct",code:"AFR",offset:2},{name:"China (hidden)",id:"",code:"CHI",offset:8},{name:"London (hidden)",id:"",code:"LON",offset:1},{name:"Seattle (hidden)",id:"",code:"STL",offset:-7},{name:"Mexico (hidden)",id:"",code:"MX",offset:-6}],P=new RegExp("s*<option value=.*(de-fra).*(us-ca-sv).*</option>","gu");function z(n,t){if(n==="id"&&t==="")throw new Error("getTimezoneByRegionKey: forbidden to get regions by id with empty id, would match multiple hidden regions");const s=(0,x.default)().utc(),a=O.filter(i=>i[n]===t);if(a.length===0)throw new Error(`getTimezoneByRegionKey: couldn't get region object for '${n}' === '${t}'`);const e=a[0];return`[${(e.offset>0?s.add(e.offset,"hour"):s.subtract(Math.abs(e.offset),"hour")).format("HH:mm")}]`}function X(n){let t=null;w.log("waiting to hook settings...");function s(){const e=window.windows[0];let l=e.tabIndex;function i(){const d=e.tabs[e.settingType].length-1;return l===d}function u(){const d=document.getElementById("settHolder");!i()&&d!==null&&d.classList.remove("Crankshaft-settings"),i()&&(0,R.renderSettings)()}const b=window.showWindow.bind(window),S=e.getSettings.bind(e),L=e.changeTab.bind(e);window.showWindow=(...d)=>{const r=b(...d);if(d[0]===1){e.settingType==="basic"&&e.toggleType({checked:!0});const p=document.querySelector(".advancedSwitch input#typeBtn");p.disabled=!0,p.nextElementSibling.setAttribute("title","Crankshaft auto-enables advanced settings mode"),i()&&(0,R.renderSettings)()}return r},e.changeTab=(...d)=>{const r=L(...d);return l=e.tabIndex,u(),r},e.getSettings=(...d)=>{const r=S(...d);if(!n.regionTimezones)return r;if(r.includes('window.setSetting("defaultRegion"')&&r.match(P).length>0){const p=r.match(P)[0],f=[...(0,o.createElement)("div",{innerHTML:p}).children];for(let h=0;h<f.length;h++){const E=f[h];E.textContent+=` ${z("id",E.value)}`}const v=document.createElement("div");f.forEach(h=>v.appendChild(h));const k=v.innerHTML;return r.replace(p,k)}return r},u()}function a(){(0,o.hasOwn)(window,"showWindow")&&typeof window.showWindow=="function"&&(0,o.hasOwn)(window,"windows")&&Array.isArray(window.windows)&&window.windows.length>=0&&typeof window.windows[0]<"u"&&typeof window.windows[0].changeTab=="function"&&(clearInterval(t),w.log("hooking settings"),s())}t=setInterval(a,250)}0&&(module.exports={getTimezoneByRegionKey,regionMappings,strippedConsole,styleSettingsCSS});
