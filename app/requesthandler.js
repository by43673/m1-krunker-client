"use strict";
var l=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var m=(s,t)=>{for(var e in t)l(s,e,{get:t[e],enumerable:!0})},v=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of f(t))!b.call(s,i)&&i!==e&&l(s,i,{get:()=>t[i],enumerable:!(r=d(t,i))||r.enumerable});return s};var $=s=>v(l({},"__esModule",{value:!0}),s);var F={};m(F,{default:()=>E});module.exports=$(F);var n=require("fs"),a=require("path"),c=require("original-fs"),u=require("urlpattern-polyfill");const o="krunker.io";class E{constructor(s,t,e,r,i,p,w){this.filter={urls:[]};this.swapUrls=[];this.started=!1;this.customFilters=[];this.browserWindow=s,this.swapDir=t,this.swapperEnabled=e,this.blockerEnabled=r,this.customFiltersEnabled=i,this.defaultFilters=p.split(/\r?\n/u),this.customFilters=(0,c.readFileSync)(w,{encoding:"utf-8"}).toString().split(/\r?\n/u).filter(h=>h[0]!=="#")}start(){this.started||((0,n.existsSync)(this.swapDir)||(0,n.mkdirSync)(this.swapDir,{recursive:!0}),this.swapperEnabled&&(this.recursiveSwap(""),this.filter.urls.push(...this.swapUrls)),this.blockerEnabled&&this.filter.urls.push(...this.defaultFilters),this.customFiltersEnabled&&this.filter.urls.push(...this.customFilters.filter(s=>s!=="")),this.browserWindow.webContents.session.webRequest.onBeforeRequest(this.filter,(s,t)=>{if(this.swapperEnabled&&this.swapUrls.some(r=>new u.URLPattern(r).test(s.url))){const r=new URL(s.url).pathname,i=r.startsWith("/assets/")?(0,a.join)(this.swapDir,r.substring(7)):(0,a.join)(this.swapDir,r);return t({redirectURL:`krunker-resource-swapper:/${i}`})}return(this.blockerEnabled||this.customFiltersEnabled)&&this.filter.urls.some(r=>new u.URLPattern(r).test(s.url))?t({cancel:!0}):t({})}),this.browserWindow.webContents.session.webRequest.onHeadersReceived(({responseHeaders:s},t)=>{for(const e in s){const r=e.toLowerCase();if(r==="access-control-allow-credentials"&&s[e][0]==="true")return t(s);if(r==="access-control-allow-origin"){delete s[e];break}}return t({responseHeaders:{...s,"access-control-allow-origin":["*"]}})}),this.started=!0)}recursiveSwap(s){try{for(const t of(0,n.readdirSync)((0,a.join)(this.swapDir,s),{withFileTypes:!0})){const e=`${s}/${t.name}`;if(t.isDirectory())this.recursiveSwap(e);else{const r=[`*://*.${o}${e}`,`*://*.${o}${e}?*`,`*://*.${o}/assets${e}`,`*://*.${o}/assets${e}?*`];this.swapUrls.push(.../^\/(?:models|textures|sound|scares|videos)(?:$|\/)/u.test(e)?r:[...r,`*://comp.${o}${e}?*`,`*://comp.${o}/assets/${e}?*`])}}}catch{console.error(`Failed to resource-swap with prefix: ${s}`)}}}
